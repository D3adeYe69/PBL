<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <title>Login</title>
    <style>
      body {
        font-family: "Crimson Text", serif;
      }
    </style>
  </head>
  <body>
    <div class="screen bg-gradient-to-t from-pink-300 to-white h-screen">
      <div
        class="bot-container flex flex-col justify-end items-center h-screen pb-[13%] gap-7"
      >
        <div class="title text-[#c22165] text-5xl mb-4 font-bold">
          HabitQuest
        </div>
        <div class="inputs flex flex-col items-center justify-center gap-2">
          <div class="input">
            <input
              id="email"
              type="text"
              placeholder="Email"
              class="bg-[#fec6ee] text-[#c22165] focus:placeholder-transparent focus:border-pink-600 focus:outline-none text-xl font-bold placeholder-[#c22165] px-5 py-2 text-center rounded-md font-bold border border-pink-400"
              required
            />
          </div>
          <div class="input">
            <input
              id="password"
              type="password"
              placeholder="Password"
              class="bg-[#fec6ee] text-[#c22165] text-xl focus:outline-none focus:border-pink-600 focus:placeholder-transparent placeholder-[#c22165] px-5 py-2 text-center font-bold border border-pink-400 rounded-md"
              required
            />
          </div>
        </div>
        <div
          id="loginButton"
          class="button bg-[#c22165] mt-2 inline-flex text-xl justify-center items-center px-14 py-1.5 rounded-md cursor-not-allowed opacity-50"
        >
          <span class="text-[#fec6ee]">Login</span>
        </div>
        <div
          id="generalError"
          class="text-red-500 text-sm hidden mt-2 text-center"
        ></div>
        <div class="account text-[#c22165] text-lg mt-24">
          Don't have an account?
          <a href="signup" class="underline font-bold">Sign up</a>
        </div>
      </div>
    </div>

    <script>
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const loginButton = document.getElementById("loginButton");
      const generalError = document.getElementById("generalError");

      emailInput.addEventListener("input", checkFields);
      passwordInput.addEventListener("input", checkFields);

      function checkFields() {
        hideErrorMessages();
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        const allFilled = isValidEmail(email) && password.length > 0;

        toggleButton(allFilled);
      }

      function toggleButton(enable) {
        if (enable) {
          loginButton.classList.remove("cursor-not-allowed", "opacity-50");
          loginButton.classList.add("cursor-pointer", "opacity-100");
          loginButton.onclick = () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            fetch("/login", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({
                email: email,
                password: password,
              }),
            })
              .then((response) => {
                if (response.ok) {
                  return response.json();
                } else {
                  return response.json().then((text) => {
                    throw new Error(text.error);
                  });
                }
              })
              .then((data) => {
                if (data.success) {
                  window.location.href = "/choose";
                }
              })
              .catch((error) => {
                showError(error.message);
              });
          };
        } else {
          loginButton.classList.add("cursor-not-allowed", "opacity-50");
          loginButton.classList.remove("cursor-pointer", "opacity-100");
          loginButton.onclick = null; // Disable the click handler
        }
      }

      function showError(message) {
        generalError.textContent = message; // Set the error message
        generalError.classList.remove("hidden"); // Show the error message
      }

      function hideErrorMessages() {
        generalError.classList.add("hidden"); // Hide general error message
      }

      function isValidEmail(email) {
        return /\S+@\S+\.\S+/.test(email); // Simple email regex
      }
    </script>
  </body>
</html>
